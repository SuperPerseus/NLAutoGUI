# -*- coding: utf-8 -*-
import json
from zhipuai import ZhipuAI
from get_hwnd import WindowEnumerator
import Tool_Mediator
import time


class NLP:
    MAX_HISTORY_LENGTH = 8
    conversation_history = []
    full_response_content = ""
    result_path = "result.json"

    def __init__(self, mission, tool: Tool_Mediator):
        self.tool = tool
        self.mission = mission
        with open("H:\Project_Warehouse\API令牌.txt", 'r', encoding='utf-8') as f:
            self.api_token = f.read()

        prompt_path = "prompt.json"
        result_path = "result.json"
        with open(prompt_path, 'r', encoding='utf-8') as f:
            self.prompt = f.read()

    def NLP_find_mission(self):
        client = ZhipuAI(api_key=self.api_token)
        user_input = self.mission
        enumerator = WindowEnumerator()
        json_data = json.dumps(enumerator.windows, ensure_ascii=False)
        print(json_data)
        response = client.chat.completions.create(
            model="glm-4-plus",
            messages=[
                {"role": "system",
                 "content": "你需要根据传入的句柄和进程名，再结合用户自然语言中想操作的具体进程给出句柄号。"
                            "注意，你只用打印你觉得最匹配的句柄号(例如：133304，yyyy。只准返回句柄号)，如果你有发现有多个你觉得符合条件的结果，就返回-1"},
                {"role": "user",
                 "content": f"当前系统为windows11，系统分辨率为2560*1440，当前系统的句柄和标题如下{json_data}，你的任务是{user_input}"},
            ],
            stream=False,
            do_sample=False,
            temperature=0.0

        )
        full_response_content = response.choices[0].message.content
        print(full_response_content)
        self.full_response_content = full_response_content
        return full_response_content

    def NLP_do_mission(self):
        mission = self.mission
        prompt_message = self.prompt
        client = ZhipuAI(api_key=self.api_token)

        init_mess = {"role": "system",
                     "content": f"{prompt_message}"}
        self.conversation_history.append(init_mess)
        init_mess = {"role": "user",
                     "content": f"当前系统为windows11，系统分辨率为2560*1440，当前需要执行的任务是{mission}"}
        self.conversation_history.append(init_mess)
        while True:
            response = client.chat.completions.create(
                model="glm-4-plus",
                messages=self.conversation_history,
                stream=False,
                do_sample=False,
                temperature=0.0
            )
            full_response_content = response.choices[0].message.content
            print(full_response_content + "pre")
            clean_response = self.NLP_formatcheck(full_response_content)
            if clean_response == "-1" or len(self.conversation_history) >= 14:
                delete_subscript = list(self.deHistory_message(self.conversation_history))
                # 使用倒序索引来删除元素，防止下标变化影响删除操作
                for i in sorted(delete_subscript, reverse=True):
                    try:
                        # 尝试将索引转换为整数
                        index = int(i)
                        if index < len(self.conversation_history):
                            del self.conversation_history[index]
                    except ValueError as e:
                        # 如果转换失败，打印错误信息
                        print(f"An error occurred:  '{i}'")
                print(self.conversation_history)
                continue
            print(clean_response + "back")
            ans = self.tool.analy(clean_response)
            mess = {"role": "user",
                    "content": f"{ans}"}
            self.conversation_history.append(mess)
            with open(self.result_path, 'w', encoding='utf-8') as file:
                # 遍历列表中的每一项，并写入文件
                for item in self.conversation_history:
                    # 写入每一行，并添加换行符
                    file.write(f"{item}" + "\n")

    def NLP_formatcheck(self, unformat: str):
        client = ZhipuAI(api_key=self.api_token)
        response = client.chat.completions.create(
            model="glm-4-plus",
            messages=[
                {"role": "system",
                 "content": "你需要把输入的内容格式化为标准的格式再输出，只准返回符合规定的结果，不允许任何其它的字符出现。"
                            "你需要把待会传入内容前面的```json和末尾的```全都去掉，返回一个干净的值。"
                            "键按顺序排列分别是action，mouse_list，mouse_slide_mode，keyboard_list。"
                            "如果输入的内容是‘mouse_action, [[45, 1326]], False, NA’这种只有值没有键的情况，你需要把按顺序和上文给你的键的顺序组装成{\"action\":\"mouse_action\",\"mouse_list\":\"[[45, 1326]]\",\"mouse_slide_mode\":\"NA\",\"keyboard_list\":\"NA\"}"
                            "你在把结果恢复成一个标准的键值对格式后，仍然要返回一个干净的值，不允许出现```json和末尾的```。"
                            "如果传入的内容出现了这四个键之外的非法键，则返回-1"
                            "非法示例：输入“根据历史对话和当前任务，下一步需要清理QQ缓存。由于已经识别到“设置”按钮的位置，因此下一步是点击该按钮以进入设置界面。”，输入的内容和上文的键和值都对不上，那就返回-1"
                 },
                {"role": "user",
                 "content": f"{unformat}"},
            ],
            stream=False,
            do_sample=False,
            temperature=0.01
        )
        full_response_content = response.choices[0].message.content
        self.full_response_content = full_response_content
        return full_response_content

    def deHistory_message(self, conversation_history: list):
        client = ZhipuAI(api_key=self.api_token)
        response = client.chat.completions.create(
            model="glm-4-plus",
            messages=[
                {"role": "system",
                 "content": "你是历史信息的清洗者，会识别传入的历史信息列表里面你觉得过期并应该删除的消息,或者是过于冗长的信息并返回它们的下标。"
                            "注意，你只准返回列表格式的结果，不允许任何其它的字符，不要打印```或者别的提示字符，像这样的‘这意味着除了前两个元素和最后两个元素之外，其余的元素都将被删除。’"
                            "你的目标是确保删除后的历史信息仍然能给大模型传达足够的信息来决定下一步对话的内容，而不能全都删干净了，删干净了就代着大模型无法从历史信息内获取刚才和用户讲了什么"
                            "传入的历史信息是和大模型交流的历史信息，每个元素都是由字典包装的，并且开头都形如‘{'role': 'user', 'content':’}，你要注意不要把字典内的结果识别为列表下标"
                            "另外我会告诉你传入历史信息的列表元素总数一共是多少，你不应该给出数字严重越界的返回结果，比如传入的历史信息元素总数为7，你就不应该返回值像这样的，下标都超过6了，列表访问会越界的‘[2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,……’"
                            "比如说传入的内容有15个元素，那么你除了下标为0、下标为1的元素不删，下标的后四个的元素不删，剩下的元素都要删掉，你可以返回'[2,3,4,5,6,7,8,9,10]',也就是表示只有前两个元素和倒数四个元素会被保留。"
                            "当然，这个选择保留多少个元素可以你自行阅读传入的历史信息后决定，但是前两个元素和最后的四个元素是绝对不能删的"
                 },
                {"role": "user",
                 "content": f"传入的历史信息元素总数为{len(conversation_history)},下面是历史信息列表{conversation_history}"},
            ],
            stream=False,
            do_sample=True,
            temperature=0.01
        )
        full_response_content = response.choices[0].message.content
        print(full_response_content)
        return full_response_content


if __name__ == '__main__':
    mission = ""
    tool = ""
    nlp = NLP(mission, tool)
    time = 0
    while True:
        time += 1
        nlp.conversation_history = [{'role': 'system',
                                     'content': '{\n  "描述": "你是能够理解传入的GUI元素识别结果和OCR文字识别结果的大模型，能根据用户需求和历史对话逐步提供详细指令。不允许任何违反输出格式的结果，只能打印无换行符的json字符串，任何时候都只准打印json，不允许打印别的内容",\n  "所有可能从本地上传的内容": {\n    "历史信息": "用于给你理解用户需求和之前上下文的对话历史",\n    "工具类的传参含义": {\n      "注意，下文所介绍的所有可能上传值，都是字典格式，也就是工具类当键值，变量当value": "",\n      "CV_action": "CV类的回传参数，格式是json，里面会标注可能被匹配的GUI元素的位置和其置信度",\n      "OCR_action": "OCR类的回传参数，格式是json，里面会标注被检索到的所有文本，它们的位置和其置信度",\n      "mouse_action": "虚拟鼠标的回传参数，如果正常执行，就会返回True，反之则为False",\n      "keyboard_action": "虚拟鼠标的回传参数，如果正常执行，就会返回True，反之则为False"\n    }\n  },\n  "输出格式": {\n    "格式要求": [\n      "你在一次http请求中只能返回一行字符串，我不希望解析request的返回值后解析出来多于一行的值",\n      "你的返回值必须遵守输出格式",\n      "如果有不填写的参数，则打印NA占位",\n      "如果不知道输出什么，默认输出default",\n      "注意，必须以符合字符串元组的格式打印，需要携带双引号和逗号"\n    ],\n    "操作格式": "IO动作类型, 鼠标坐标数组, 鼠标滑动模式(如果启动滑动模式，则打印True，否则默认是点击模式)，键盘操作按键",\n    "操作格式的各限定取值": {\n      "IO动作类型": [\n        "mouse_action",\n        "keyboard_action",\n        "OCR_action",\n        "CV_action"\n      ],\n      "鼠标指令操作规范": {\n        "GUI定位起始位置": "OCR和CV传递的定位起始位置都是屏幕的左上角，即左上角为[0,0]点，然后右下角为系统分辨率最大值点",\n        "鼠标坐标数组规范": {\n          "点击屏幕右上角(2560,0)后再点击(1440,600)": "[[2560,0],[1440,600]]",\n          "点击屏幕横纵坐标(x,y)": "[[x,y]]"\n        },\n        "鼠标滑动模式": {\n          "启动长按滑动模式需要再操作格式的鼠标滑动模式返回": "True",\n          "先点屏幕右上角(2560,0)后滑动到(1440,600)": "[[2560,0],[1440,600]]",\n          "长按屏幕右上角(2560,0)": "[[2560,0],[2560,0],[2560,0]]"\n        }\n      },\n      "键盘指令操作规范": {\n        "键盘操作方法": [\n          "你可以发送任意组合和数量的键盘操作指令，后续类函数可以接收一个不定长度的列表"\n        ],\n        "按压操作规范": {\n          "按压X键": "[press-X]",\n          "按压左shift键": "[press-LSHIFT]",\n          "按压左ctrl键的同时按压C键": "[press-LSHIFT]",\n          "按压\\"任意\\"键": "[press-任意]"\n        },\n        "释放操作规范": {\n          "释放A键": "[release-A]",\n          "释放a键": "[release-a]",\n          "释放F1键": "[release-F1]",\n          "释放\\"任意\\"键": "[release-任意]"\n        }\n      }\n    },\n    "输出范例": {\n      "调用CV工具并获取分析结果": {\n        "action":"CV_action",\n        "mouse_list":"NA",\n        "mouse_slide_mode":"NA",\n        "keyboard_list":"NA"\n      },\n      "短点击屏幕右上角": {\n        "action":"mouse_action",\n        "mouse_list":"[[2560, 10]]",\n        "mouse_slide_mode":"False",\n        "keyboard_list":"NA"\n      },\n      "鼠标从屏幕右上角滑动到左下角": {\n        "action": "mouse_action",\n        "mouse_list": "[[2560, 0], [0, 1440]]",\n        "mouse_slide_mode": "True",\n        "keyboard_list": "NA"\n      },\n      "鼠标短点击屏幕右上角后再点击左下角": {\n        "action": "mouse_action",\n        "mouse_list": "[[2560, 0], [0, 1440]]",\n        "mouse_slide_mode": "False",\n        "keyboard_list": "NA"\n      },\n      "点击两次左shift键后点击D键": {\n        "action": "keyboard_action",\n        "mouse_list": "NA",\n        "mouse_slide_mode": "NA",\n        "keyboard_list": "[press-LSHIFT, release-LSHIFT, press-LSHIFT, release-LSHIFT, press-D, release-D]"\n      },\n      "使用ctrl+a进行全选中": {\n        "action": "keyboard_action",\n        "mouse_list": "NA",\n        "mouse_slide_mode": "NA",\n        "keyboard_list": "[press-CTRL,press-A,release-CTRL,release-A]"\n      }\n    },\n    "非法的输出范例": {\n      "在输出参数的第四项中错误的把OCR的识别返回参数当成了对键盘的调用参数": {\n        "action": "OCR_action",\n        "mouse_list":"NA",\n        "mouse_slide_mode":"NA",\n        "keyboard_list": "{\\"text\\": \\"QQ\\", \\"location\\": [0, 0], \\"confidence\\": 0.95}"\n      }\n    }\n  },\n  "工作流程示范": {\n    "清除QQ缓存": {\n      "第一步指令": {\n        "action": "CV_action",\n        "mouse_list": "NA",\n        "mouse_slide_mode": "NA",\n        "keyboard_list": "[press-LSHIFT, release-LSHIFT, press-LSHIFT, release-LSHIFT, press-D, release-D]",\n        "释义": "（释义，这代表着你需要获取CV类对GUI元素的定位才能执行下一步操作）"\n      },\n      "第一次回传参数": [\n        "CV_action:\\"../image/template\\\\newqq_mainsetting_but.png\\": [",\n        "{",\n        "\\"top_left\\": [",\n        "0,",\n        "1282",\n        "],",\n        "\\"top_right\\": [",\n        "93,",\n        "1282",\n        "],",\n        "\\"bottom_left\\": [",\n        "0,",\n        "1370",\n        "],",\n        "\\"bottom_right\\": [",\n        "93,",\n        "1370",\n        "]",\n        "}"\n      ],\n      "第二次你的思考过程": "由于CV类获取到了设置的按键(newqq_mainsetting_but.png)，所以为了实现清除QQ缓存的要求，就需要点击这里从而进入QQ主界面的设置",\n      "第二次指令": {\n        "action": "mouse_action",\n        "mouse_list": "[[45,1326]]",\n        "mouse_slide_mode": "False",\n        "keyboard_list": "NA",\n        "释义": "（释义，这代表着你需要虚拟鼠标类对按钮进行点击）"\n      },\n      "第二次回传参数": "True",\n      "第三次你的思考过程": "现在已经进入了QQ的设置类，需要对当前屏幕再进行一次OCR识别又或者是CV识别，寻找可能的元素",\n      "第三次指令": {\n        "action": "OCR_action",\n        "mouse_list": "NA",\n        "mouse_slide_mode": "NA",\n        "keyboard_list": "NA"\n      },\n      "第三次回传参数": [\n        "OCR_action:",\n        "{",\n        "\\"bounding_box\\": [",\n        "[",\n        "101.0,",\n        "1226.0",\n        "],",\n        "[",\n        "189.0,",\n        "1226.0",\n        "],",\n        "[",\n        "189.0,",\n        "1263.0",\n        "],",\n        "[",\n        "101.0,",\n        "1263.0",\n        "]",\n        "],",\n        "\\"text\\": \\"\\\\u8bbe\\\\u7f6e\\",",\n        "\\"confidence\\": 0.9987437725067139",\n        "},"\n      ],\n      "第四次你的思考过程": "通过OCR识别已经寻找到了‘设置’的存在和位置，因此可以不用再使用CV类进行搜索了。而且需要点击一次\'设置\'，从而进入设置窗口",\n      "第四次指令": {\n        "action": "mouse_action",\n        "mouse_list": "[[140,1245]]",\n        "mouse_slide_mode": "False",\n        "keyboard_list": "NA",\n        "释义": "（释义，点击识别到的设置存在的坐标中心，从而能点击到它）"\n      },\n      "第四次回传参数":"True"\n    }\n  }\n}'},
                                    {'role': 'user',
                                     'content': '当前系统为windows11，系统分辨率为2560*1440，当前需要执行的任务是清理QQ缓存'},
                                    {'role': 'user',
                                     'content': "{'../image/template\\\\newqq_exit_but.png': [], '../image/template\\\\newqq_mainsetting_but.png': []}"},
                                    {'role': 'user',
                                     'content': "{'../image/template\\\\newqq_exit_but.png': [], '../image/template\\\\newqq_mainsetting_but.png': []}"},
                                    {'role': 'user',
                                     'content': '[\n  {\n    "bounding_box": [\n      [\n        205.0,\n        13.0\n      ],\n      [\n        320.0,\n        13.0\n      ],\n      [\n        320.0,\n        42.0\n      ],\n      [\n        205.0,\n        42.0\n      ]\n    ],\n    "text": "\\u667a\\u8c31\\u6e05\\u8a00",\n    "confidence": 0.9982962012290955\n  },\n  {\n    "bounding_box": [\n      [\n        603.0,\n        13.0\n      ],\n      [\n        957.0,\n        13.0\n      ],\n      [\n        957.0,\n        40.0\n      ],\n      [\n        603.0,\n        40.0\n      ]\n    ],\n    "text": "\\u3010\\u611a\\u516c\\u7cfb\\u5217\\u3011 \\u8f6f\\u8003\\u9ad8\\u7ea7-\\u67b6\\u6784\\u8bbe\\u8ba1\\u300f\\u00d7C",\n    "confidence": 0.9448376893997192\n  },\n  {\n    "bounding_box": [\n      [\n        947.0,\n        13.0\n      ],\n      [\n        1251.0,\n        13.0\n      ],\n      [\n        1251.0,\n        40.0\n      ],\n      [\n        947.0,\n        40.0\n      ]\n    ],\n    "text": "\\u7cfb\\u7edf\\u8d28\\u91cf\\u5c5e\\u6027\\u4e0e\\u67b6\\u6784\\u8bc4\\u4f30_\\u8d28\\u91cf\\u6548F>",\n    "confidence": 0.9413289427757263\n  },\n  {\n    "bounding_box": [\n      [\n        1280.0,\n        8.0\n      ],\n      [\n        1512.0,\n        8.0\n      ],\n      [\n        1512.0,\n        42.0\n      ],\n      [\n        1280.0,\n        42.0\n      ]\n    ],\n    "text": "\\u25a0\\u6280\\u672f\\u52a9\\u624b\\u00b7LobeChat",\n    "confidence": 0.9872706532478333\n  },\n  {\n    "bounding_box": [\n      [\n        93.0,\n        69.0\n      ],\n      [\n        123.0,\n        69.0\n      ],\n      [\n        123.0,\n        95.0\n      ],\n      [\n        93.0,\n        95.0\n      ]\n    ],\n    "text": "C",\n    "confidence": 0.564446210861206\n  },\n  {\n    "bounding_box": [\n      [\n        168.0,\n        61.0\n      ],\n      [\n        1184.0,\n        64.0\n      ],\n      [\n        1184.0,\n        101.0\n      ],\n      [\n        168.0,\n        98.0\n      ]\n    ],\n    "text": " https:/eightstars.top/chat?agent=&session=87a5ea9c-557b-4e26-bea7-25c0f52adff8&topic=G7eiNisT",\n    "confidence": 0.9803657531738281\n  },\n  {\n    "bounding_box": [\n      [\n        1869.0,\n        66.0\n      ],\n      [\n        2061.0,\n        66.0\n      ],\n      [\n        2061.0,\n        95.0\n      ],\n      [\n        1869.0,\n        95.0\n      ]\n    ],\n    "text": "A",\n    "confidence": 0.6949041485786438\n  },\n  {\n    "bounding_box": [\n      [\n        2307.0,\n        69.0\n      ],\n      [\n        2336.0,\n        69.0\n      ],\n      [\n        2336.0,\n        93.0\n      ],\n      [\n        2307.0,\n        93.0\n      ]\n    ],\n    "text": "+",\n    "confidence": 0.6198927760124207\n  },\n  {\n    "bounding_box": [\n      [\n        2451.0,\n        74.0\n      ],\n      [\n        2464.0,\n        74.0\n      ],\n      [\n        2464.0,\n        90.0\n      ],\n      [\n        2451.0,\n        90.0\n      ]\n    ],\n    "text": "\\u4e2a",\n    "confidence": 0.976889967918396\n  },\n  {\n    "bounding_box": [\n      [\n        723.0,\n        130.0\n      ],\n      [\n        968.0,\n        130.0\n      ],\n      [\n        968.0,\n        167.0\n      ],\n      [\n        723.0,\n        167.0\n      ]\n    ],\n    "text": "\\u6280\\u672f\\u52a9\\u624b gpt-4-turbo",\n    "confidence": 0.9589454531669617\n  },\n  {\n    "bounding_box": [\n      [\n        123.0,\n        146.0\n      ],\n      [\n        296.0,\n        146.0\n      ],\n      [\n        296.0,\n        183.0\n      ],\n      [\n        123.0,\n        183.0\n      ]\n    ],\n    "text": "LobeChat",\n    "confidence": 0.9993525147438049\n  },\n  {\n    "bounding_box": [\n      [\n        512.0,\n        143.0\n      ],\n      [\n        549.0,\n        143.0\n      ],\n      [\n        549.0,\n        177.0\n      ],\n      [\n        512.0,\n        177.0\n      ]\n    ],\n    "text": "\\u7530",\n    "confidence": 0.804233193397522\n  },\n  {\n    "bounding_box": [\n      [\n        2357.0,\n        140.0\n      ],\n      [\n        2395.0,\n        140.0\n      ],\n      [\n        2395.0,\n        175.0\n      ],\n      [\n        2357.0,\n        175.0\n      ]\n    ],\n    "text": "\\u3002",\n    "confidence": 0.5186259150505066\n  },\n  {\n    "bounding_box": [\n      [\n        2488.0,\n        148.0\n      ],\n      [\n        2520.0,\n        148.0\n      ],\n      [\n        2520.0,\n        169.0\n      ],\n      [\n        2488.0,\n        169.0\n      ]\n    ],\n    "text": "\\u4e09",\n    "confidence": 0.9244034290313721\n  },\n  {\n    "bounding_box": [\n      [\n        725.0,\n        161.0\n      ],\n      [\n        1005.0,\n        161.0\n      ],\n      [\n        1005.0,\n        188.0\n      ],\n      [\n        725.0,\n        188.0\n      ]\n    ],\n    "text": "\\u64c5\\u957f\\u63d0\\u4f9b\\u8be6\\u5c3d\\u7684\\u6280\\u672f\\u95ee\\u9898\\u89e3\\u51b3\\u6307\\u5bfc",\n    "confidence": 0.9949339032173157\n  },\n  {\n    "bounding_box": [\n      [\n        139.0,\n        222.0\n      ],\n      [\n        333.0,\n        222.0\n      ],\n      [\n        333.0,\n        259.0\n      ],\n      [\n        139.0,\n        259.0\n      ]\n    ],\n    "text": "Q \\u641c\\u7d22\\u52a9\\u624b\\u548c\\u5bf9\\u8bdd.",\n    "confidence": 0.9309687614440918\n  },\n  {\n    "bounding_box": [\n      [\n        35.0,\n        233.0\n      ],\n      [\n        75.0,\n        233.0\n      ],\n      [\n        75.0,\n        270.0\n      ],\n      [\n        35.0,\n        270.0\n      ]\n    ],\n    "text": "\\u53e3",\n    "confidence": 0.9993565678596497\n  },\n  {\n    "bounding_box": [\n      [\n        488.0,\n        225.0\n      ],\n      [\n        541.0,\n        225.0\n      ],\n      [\n        541.0,\n        254.0\n      ],\n      [\n        488.0,\n        254.0\n      ]\n    ],\n    "text": "Ctrl K ",\n    "confidence": 0.8852469325065613\n  },\n  {\n    "bounding_box": [\n      [\n        2155.0,\n        230.0\n      ],\n      [\n        2251.0,\n        230.0\n      ],\n      [\n        2251.0,\n        267.0\n      ],\n      [\n        2155.0,\n        267.0\n      ]\n    ],\n    "text": "\\u89d2\\u8272\\u8bbe\\u5b9a",\n    "confidence": 0.9989615678787231\n  },\n  {\n    "bounding_box": [\n      [\n        933.0,\n        289.0\n      ],\n      [\n        1883.0,\n        289.0\n      ],\n      [\n        1883.0,\n        323.0\n      ],\n      [\n        933.0,\n        323.0\n      ]\n    ],\n    "text": "{\\"action\\":\\"mouse_action\\",\\"mouse_list\\":[(45, 1326)],\\"mouse_slide_mode\\":false,\\"keyboard _list\\"\\"NA\\") ",\n    "confidence": 0.9476118087768555\n  },\n  {\n    "bounding_box": [\n      [\n        2155.0,\n        291.0\n      ],\n      [\n        2429.0,\n        291.0\n      ],\n      [\n        2429.0,\n        326.0\n      ],\n      [\n        2155.0,\n        326.0\n      ]\n    ],\n    "text": "Here\'s a prompt for myself:",\n    "confidence": 0.9858528971672058\n  },\n  {\n    "bounding_box": [\n      [\n        200.0,\n        341.0\n      ],\n      [\n        309.0,\n        341.0\n      ],\n      [\n        309.0,\n        379.0\n      ],\n      [\n        200.0,\n        379.0\n      ]\n    ],\n    "text": "\\u968f\\u4fbf\\u804a\\u804a",\n    "confidence": 0.9976422786712646\n  },\n  {\n    "bounding_box": [\n      [\n        933.0,\n        344.0\n      ],\n      [\n        2003.0,\n        344.0\n      ],\n      [\n        2003.0,\n        379.0\n      ],\n      [\n        933.0,\n        379.0\n      ]\n    ],\n    "text": "\\u8fd9\\u4e32\\u5b57\\u7b26\\u4e32\\uff0c\\u5728\\u4f20\\u5165\\u5230json\\u89e3\\u7801\\u5668\\u7684\\u65f6\\u5019\\uff0c\\u62a5\\u9519 File\\"H:\\\\Anaconda\\\\envs\\\\ds1\\\\libjson_init_-.py\\",line 357,in loads",\n    "confidence": 0.9455057978630066\n  },\n  {\n    "bounding_box": [\n      [\n        2160.0,\n        344.0\n      ],\n      [\n        2515.0,\n        344.0\n      ],\n      [\n        2515.0,\n        379.0\n      ],\n      [\n        2160.0,\n        379.0\n      ]\n    ],\n    "text": "\\"l am an Al assistant who only speak",\n    "confidence": 0.9745116829872131\n  },\n  {\n    "bounding_box": [\n      [\n        933.0,\n        376.0\n      ],\n      [\n        1272.0,\n        376.0\n      ],\n      [\n        1272.0,\n        410.0\n      ],\n      [\n        933.0,\n        410.0\n      ]\n    ],\n    "text": "return _default_decoder.decode(s)",\n    "confidence": 0.9850572347640991\n  },\n  {\n    "bounding_box": [\n      [\n        2155.0,\n        376.0\n      ],\n      [\n        2507.0,\n        379.0\n      ],\n      [\n        2506.0,\n        416.0\n      ],\n      [\n        2155.0,\n        413.0\n      ]\n    ],\n    "text": "chinese,skilled in computer science,",\n    "confidence": 0.9625577926635742\n  },\n  {\n    "bounding_box": [\n      [\n        933.0,\n        410.0\n      ],\n      [\n        1608.0,\n        410.0\n      ],\n      [\n        1608.0,\n        447.0\n      ],\n      [\n        933.0,\n        447.0\n      ]\n    ],\n    "text": "File \\"H:Anaconda\\\\envs\\\\ds1\\\\lib\\\\json\\\\decoder.py\\", line 337, in decode",\n    "confidence": 0.9795451164245605\n  },\n  {\n    "bounding_box": [\n      [\n        2157.0,\n        413.0\n      ],\n      [\n        2493.0,\n        413.0\n      ],\n      [\n        2493.0,\n        450.0\n      ],\n      [\n        2157.0,\n        450.0\n      ]\n    ],\n    "text": "with up-to-date knowledge of the",\n    "confidence": 0.9980424642562866\n  },\n  {\n    "bounding_box": [\n      [\n        133.0,\n        429.0\n      ],\n      [\n        227.0,\n        429.0\n      ],\n      [\n        227.0,\n        466.0\n      ],\n      [\n        133.0,\n        466.0\n      ]\n    ],\n    "text": "\\u9ed8\\u8ba4\\u5217\\u8868",\n    "confidence": 0.9993948936462402\n  },\n  {\n    "bounding_box": [\n      [\n        933.0,\n        447.0\n      ],\n      [\n        1405.0,\n        447.0\n      ],\n      [\n        1405.0,\n        482.0\n      ],\n      [\n        933.0,\n        482.0\n      ]\n    ],\n    "text": "obj, end = self.raw_decode(s, idx=_w(s, 0).end0) ",\n    "confidence": 0.9675025343894958\n  },\n  {\n    "bounding_box": [\n      [\n        2157.0,\n        447.0\n      ],\n      [\n        2523.0,\n        447.0\n      ],\n      [\n        2523.0,\n        482.0\n      ],\n      [\n        2157.0,\n        482.0\n      ]\n    ],\n    "text": "latest technologies and tech stacks. I",\n    "confidence": 0.9968870878219604\n  },\n  {\n    "bounding_box": [\n      [\n        933.0,\n        476.0\n      ],\n      [\n        1651.0,\n        476.0\n      ],\n      [\n        1651.0,\n        514.0\n      ],\n      [\n        933.0,\n        514.0\n      ]\n    ],\n    "text": "File \\"H:VAnaconda\\\\envs\\\\ds1\\\\lib)json\\\\decoder.py\\", line 355, in raw_decode",\n    "confidence": 0.9625623226165771\n  },\n  {\n    "bounding_box": [\n      [\n        2157.0,\n        482.0\n      ],\n      [\n        2509.0,\n        482.0\n      ],\n      [\n        2509.0,\n        516.0\n      ],\n      [\n        2157.0,\n        516.0\n      ]\n    ],\n    "text": "excel at providing detailed, step-by-",\n    "confidence": 0.9989174604415894\n  },\n  {\n    "bounding_box": [\n      [\n        200.0,\n        498.0\n      ],\n      [\n        309.0,\n        498.0\n      ],\n      [\n        309.0,\n        535.0\n      ],\n      [\n        200.0,\n        535.0\n      ]\n    ],\n    "text": "\\u6280\\u672f\\u52a9\\u624b",\n    "confidence": 0.9994572401046753\n  },\n  {\n    "bounding_box": [\n      [\n        504.0,\n        495.0\n      ],\n      [\n        549.0,\n        495.0\n      ],\n      [\n        549.0,\n        524.0\n      ],\n      [\n        504.0,\n        524.0\n      ]\n    ],\n    "text": "14:58",\n    "confidence": 0.9969417452812195\n  },\n  {\n    "bounding_box": [\n      [\n        933.0,\n        511.0\n      ],\n      [\n        1573.0,\n        511.0\n      ],\n      [\n        1573.0,\n        548.0\n      ],\n      [\n        933.0,\n        548.0\n      ]\n    ],\n    "text": "raise JSONDecodeError(\\"Expecting value\\", s, err.value) from None ",\n    "confidence": 0.987695574760437\n  },\n  {\n    "bounding_box": [\n      [\n        2155.0,\n        514.0\n      ],\n      [\n        2504.0,\n        511.0\n      ],\n      [\n        2504.0,\n        548.0\n      ],\n      [\n        2155.0,\n        551.0\n      ]\n    ],\n    "text": "step guidance for solving technical",\n    "confidence": 0.9982007741928101\n  },\n  {\n    "bounding_box": [\n      [\n        200.0,\n        529.0\n      ],\n      [\n        483.0,\n        535.0\n      ],\n      [\n        482.0,\n        569.0\n      ],\n      [\n        200.0,\n        564.0\n      ]\n    ],\n    "text": "\\u64c5\\u957f\\u63d0\\u4f9b\\u8be6\\u5c3d\\u7684\\u6280\\u672f\\u95ee\\u9898\\u89e3\\u51b3\\u6307\\u5bfc",\n    "confidence": 0.9991562366485596\n  },\n  {\n    "bounding_box": [\n      [\n        933.0,\n        545.0\n      ],\n      [\n        1667.0,\n        545.0\n      ],\n      [\n        1667.0,\n        580.0\n      ],\n      [\n        933.0,\n        580.0\n      ]\n    ],\n    "text": "json.decoder.JSONDecodeError: Expecting value: line 1 column 40 (char 39)",\n    "confidence": 0.985748291015625\n  },\n  {\n    "bounding_box": [\n      [\n        2157.0,\n        548.0\n      ],\n      [\n        2472.0,\n        548.0\n      ],\n      [\n        2472.0,\n        582.0\n      ],\n      [\n        2157.0,\n        582.0\n      ]\n    ],\n    "text": "problems, offering accurate and",\n    "confidence": 0.9884517192840576\n  },\n  {\n    "bounding_box": [\n      [\n        936.0,\n        580.0\n      ],\n      [\n        1027.0,\n        580.0\n      ],\n      [\n        1027.0,\n        609.0\n      ],\n      [\n        936.0,\n        609.0\n      ]\n    ],\n    "text": "\\u600e\\u4e48\\u56de\\u4e8b",\n    "confidence": 0.9995551109313965\n  },\n  {\n    "bounding_box": [\n      [\n        203.0,\n        601.0\n      ],\n      [\n        333.0,\n        601.0\n      ],\n      [\n        333.0,\n        638.0\n      ],\n      [\n        203.0,\n        638.0\n      ]\n    ],\n    "text": "\\u8bcd\\u6c47\\u7cbe\\u6790\\u5e08",\n    "confidence": 0.9989683032035828\n  },\n  {\n    "bounding_box": [\n      [\n        499.0,\n        604.0\n      ],\n      [\n        549.0,\n        604.0\n      ],\n      [\n        549.0,\n        633.0\n      ],\n      [\n        499.0,\n        633.0\n      ]\n    ],\n    "text": "10-19",\n    "confidence": 0.9130287170410156\n  },\n  {\n    "bounding_box": [\n      [\n        2157.0,\n        611.0\n      ],\n      [\n        2248.0,\n        611.0\n      ],\n      [\n        2248.0,\n        641.0\n      ],\n      [\n        2157.0,\n        641.0\n      ]\n    ],\n    "text": "\\u8bdd\\u9898138",\n    "confidence": 0.999625563621521\n  },\n  {\n    "bounding_box": [\n      [\n        200.0,\n        633.0\n      ],\n      [\n        483.0,\n        635.0\n      ],\n      [\n        482.0,\n        672.0\n      ],\n      [\n        200.0,\n        670.0\n      ]\n    ],\n    "text": "\\u64c5\\u957f\\u82f1\\u8bed\\u8bcd\\u6c47\\u5dee\\u5f02\\u8bb2\\u89e3\\u4e0e\\u5e94\\u8bd5\\u8f85\\u5bfc",\n    "confidence": 0.9971432089805603\n  },\n  {\n    "bounding_box": [\n      [\n        685.0,\n        646.0\n      ],\n      [\n        755.0,\n        646.0\n      ],\n      [\n        755.0,\n        675.0\n      ],\n      [\n        685.0,\n        675.0\n      ]\n    ],\n    "text": "14:59:09",\n    "confidence": 0.9986536502838135\n  },\n  {\n    "bounding_box": [\n      [\n        207.0,\n        669.0\n      ],\n      [\n        308.0,\n        676.0\n      ],\n      [\n        305.0,\n        713.0\n      ],\n      [\n        204.0,\n        706.0\n      ]\n    ],\n    "text": "S gpt-40",\n    "confidence": 0.9100607633590698\n  },\n  {\n    "bounding_box": [\n      [\n        2160.0,\n        680.0\n      ],\n      [\n        2360.0,\n        680.0\n      ],\n      [\n        2360.0,\n        717.0\n      ],\n      [\n        2160.0,\n        717.0\n      ]\n    ],\n    "text": "\\u9ed8\\u8ba4\\u8bdd\\u9898\\u4e34\\u65f6",\n    "confidence": 0.9979856610298157\n  },\n  {\n    "bounding_box": [\n      [\n        696.0,\n        694.0\n      ],\n      [\n        1944.0,\n        696.0\n      ],\n      [\n        1944.0,\n        733.0\n      ],\n      [\n        696.0,\n        731.0\n      ]\n    ],\n    "text": "\\u8be5\\u9519\\u8bef\\u63d0\\u793a\\u662f\\u7531\\u4e8eJSON \\u683c\\u5f0f\\u4e0d\\u6b63\\u786e\\u5bfc\\u81f4\\u7684\\u3002\\u5728JSON\\u4e2d\\uff0c\\u6240\\u6709\\u7684\\u5b57\\u7b26\\u4e32\\u90fd\\u5fc5\\u987b\\u4f7f\\u7528\\u53cc\\u5f15\\u53f7\\uff08\\"\\uff09\\u800c\\u4e0d\\u662f\\u5355\\u5f15\\u53f7\\uff08\\"\\uff09\\uff0c\\u5e76\\u4e14\\u6240\\u6709\\u7684\\u952e",\n    "confidence": 0.9861558079719543\n  },\n  {\n    "bounding_box": [\n      [\n        699.0,\n        731.0\n      ],\n      [\n        909.0,\n        731.0\n      ],\n      [\n        909.0,\n        765.0\n      ],\n      [\n        699.0,\n        765.0\n      ]\n    ],\n    "text": "\\u4e5f\\u9700\\u8981\\u7528\\u53cc\\u5f15\\u53f7\\u5305\\u56f4\\u3002",\n    "confidence": 0.9997678995132446\n  },\n  {\n    "bounding_box": [\n      [\n        2163.0,\n        746.0\n      ],\n      [\n        2432.0,\n        746.0\n      ],\n      [\n        2432.0,\n        781.0\n      ],\n      [\n        2163.0,\n        781.0\n      ]\n    ],\n    "text": "\\u2606JSON\\u683c\\u5f0f\\u9519\\u8bef\\u89e3\\u6790\\u95ee\\u9898",\n    "confidence": 0.9890292286872864\n  },\n  {\n    "bounding_box": [\n      [\n        699.0,\n        786.0\n      ],\n      [\n        912.0,\n        786.0\n      ],\n      [\n        912.0,\n        821.0\n      ],\n      [\n        699.0,\n        821.0\n      ]\n    ],\n    "text": "\\u6839\\u636e\\u4f60\\u63d0\\u4f9b\\u7684\\u5b57\\u7b26\\u4e32\\uff1a",\n    "confidence": 0.9752529263496399\n  },\n  {\n    "bounding_box": [\n      [\n        2163.0,\n        813.0\n      ],\n      [\n        2488.0,\n        813.0\n      ],\n      [\n        2488.0,\n        847.0\n      ],\n      [\n        2163.0,\n        847.0\n      ]\n    ],\n    "text": "\\u2606Python\\u53ef\\u89c6\\u5316\\u6587\\u4ef6\\u5939\\u9009\\u62e9\\u793a\\u4f8b",\n    "confidence": 0.9935863614082336\n  },\n  {\n    "bounding_box": [\n      [\n        1301.0,\n        850.0\n      ],\n      [\n        1349.0,\n        850.0\n      ],\n      [\n        1349.0,\n        881.0\n      ],\n      [\n        1301.0,\n        881.0\n      ]\n    ],\n    "text": "json",\n    "confidence": 0.9993047714233398\n  },\n  {\n    "bounding_box": [\n      [\n        1909.0,\n        855.0\n      ],\n      [\n        1928.0,\n        855.0\n      ],\n      [\n        1928.0,\n        874.0\n      ],\n      [\n        1909.0,\n        874.0\n      ]\n    ],\n    "text": "\\u53e3",\n    "confidence": 0.8398678302764893\n  },\n  {\n    "bounding_box": [\n      [\n        2163.0,\n        884.0\n      ],\n      [\n        2381.0,\n        884.0\n      ],\n      [\n        2381.0,\n        919.0\n      ],\n      [\n        2163.0,\n        919.0\n      ]\n    ],\n    "text": "\\u2606WBS\\u4efb\\u52a1\\u65b9\\u6cd5\\u8ba8\\u8bba",\n    "confidence": 0.9964793920516968\n  },\n  {\n    "bounding_box": [\n      [\n        736.0,\n        919.0\n      ],\n      [\n        813.0,\n        919.0\n      ],\n      [\n        813.0,\n        937.0\n      ],\n      [\n        736.0,\n        937.0\n      ]\n    ],\n    "text": "\\"action",\n    "confidence": 0.9919077157974243\n  },\n  {\n    "bounding_box": [\n      [\n        899.0,\n        913.0\n      ],\n      [\n        1709.0,\n        913.0\n      ],\n      [\n        1709.0,\n        940.0\n      ],\n      [\n        899.0,\n        940.0\n      ]\n    ],\n    "text": "action\\",\\"mouse_list\\":[(45, 1326)],\\"mouse_slide_mode\\":false,\\"keyboard_list\\":\\"NA\\"}",\n    "confidence": 0.9890992045402527\n  },\n  {\n    "bounding_box": [\n      [\n        2163.0,\n        956.0\n      ],\n      [\n        2509.0,\n        956.0\n      ],\n      [\n        2509.0,\n        990.0\n      ],\n      [\n        2163.0,\n        990.0\n      ]\n    ],\n    "text": "\\u2606\\u9891\\u7e41\\u9879\\u96c6\\u5173\\u8054\\u89c4\\u5219\\u5206\\u6790\\u5b9e\\u9a8c\\u6b65\\u9aa4",\n    "confidence": 0.9764646887779236\n  },\n  {\n    "bounding_box": [\n      [\n        696.0,\n        979.0\n      ],\n      [\n        1955.0,\n        982.0\n      ],\n      [\n        1955.0,\n        1027.0\n      ],\n      [\n        696.0,\n        1024.0\n      ]\n    ],\n    "text": "\\u95ee\\u9898\\u51fa\\u5728\\u201cmouse_1ist\\":[(45\\uff0c1326)\\u3011\\u8fd9\\u90e8\\u5206\\u3002\\u5728JSON\\u4e2d\\uff0c\\u5143\\u7ec4\\uff0845\\uff0c1326\\uff09\\u9700\\u8981\\u88ab\\u8868\\u793a\\u4e3a\\u4e00\\u4e2a\\u6570\\u7ec4\\uff0c\\u5373\\u4f7f\\u7528\\u65b9\\u62ec\\u53f7\\u3010\\uff3d\\u800c",\n    "confidence": 0.926166296005249\n  },\n  {\n    "bounding_box": [\n      [\n        697.0,\n        1013.0\n      ],\n      [\n        888.0,\n        1019.0\n      ],\n      [\n        887.0,\n        1057.0\n      ],\n      [\n        696.0,\n        1051.0\n      ]\n    ],\n    "text": "\\u4e0d\\u662f\\u5706\\u62ec\\u53f7\\uff08\\uff09\\u3002",\n    "confidence": 0.9965074062347412\n  },\n  {\n    "bounding_box": [\n      [\n        1989.0,\n        1022.0\n      ],\n      [\n        2085.0,\n        1022.0\n      ],\n      [\n        2085.0,\n        1040.0\n      ],\n      [\n        1989.0,\n        1040.0\n      ]\n    ],\n    "text": "\\u8df3\\u8f6c\\u81f3\\u5f53\\u524d",\n    "confidence": 0.9991570711135864\n  },\n  {\n    "bounding_box": [\n      [\n        984.0,\n        1122.0\n      ],\n      [\n        1099.0,\n        1122.0\n      ],\n      [\n        1099.0,\n        1151.0\n      ],\n      [\n        984.0,\n        1151.0\n      ]\n    ],\n    "text": "\\u4f7f\\u7528590",\n    "confidence": 0.9986364245414734\n  },\n  {\n    "bounding_box": [\n      [\n        613.0,\n        1175.0\n      ],\n      [\n        757.0,\n        1175.0\n      ],\n      [\n        757.0,\n        1212.0\n      ],\n      [\n        613.0,\n        1212.0\n      ]\n    ],\n    "text": "\\u8f93\\u5165\\u804a\\u5929\\u5185\\u5bb9.",\n    "confidence": 0.9336594343185425\n  },\n  {\n    "bounding_box": [\n      [\n        37.0,\n        1292.0\n      ],\n      [\n        69.0,\n        1292.0\n      ],\n      [\n        69.0,\n        1331.0\n      ],\n      [\n        37.0,\n        1331.0\n      ]\n    ],\n    "text": "\\u65e5",\n    "confidence": 0.57899010181427\n  },\n  {\n    "bounding_box": [\n      [\n        1704.0,\n        1300.0\n      ],\n      [\n        1864.0,\n        1300.0\n      ],\n      [\n        1864.0,\n        1326.0\n      ],\n      [\n        1704.0,\n        1326.0\n      ]\n    ],\n    "text": "\\u53d1\\u9001\\uff0f\\u6362\\u884c",\n    "confidence": 0.882614254951477\n  },\n  {\n    "bounding_box": [\n      [\n        1909.0,\n        1300.0\n      ],\n      [\n        1933.0,\n        1300.0\n      ],\n      [\n        1933.0,\n        1321.0\n      ],\n      [\n        1909.0,\n        1321.0\n      ]\n    ],\n    "text": "\\u7530",\n    "confidence": 0.7865109443664551\n  },\n  {\n    "bounding_box": [\n      [\n        93.0,\n        1387.0\n      ],\n      [\n        189.0,\n        1387.0\n      ],\n      [\n        189.0,\n        1424.0\n      ],\n      [\n        93.0,\n        1424.0\n      ]\n    ],\n    "text": "\\u03b1\\u641c\\u7d22",\n    "confidence": 0.8373651504516602\n  },\n  {\n    "bounding_box": [\n      [\n        763.0,\n        1387.0\n      ],\n      [\n        800.0,\n        1387.0\n      ],\n      [\n        800.0,\n        1419.0\n      ],\n      [\n        763.0,\n        1419.0\n      ]\n    ],\n    "text": "?",\n    "confidence": 0.6742404699325562\n  },\n  {\n    "bounding_box": [\n      [\n        832.0,\n        1390.0\n      ],\n      [\n        864.0,\n        1390.0\n      ],\n      [\n        864.0,\n        1414.0\n      ],\n      [\n        832.0,\n        1414.0\n      ]\n    ],\n    "text": "bitbi",\n    "confidence": 0.7645889520645142\n  },\n  {\n    "bounding_box": [\n      [\n        963.0,\n        1390.0\n      ],\n      [\n        997.0,\n        1390.0\n      ],\n      [\n        997.0,\n        1414.0\n      ],\n      [\n        963.0,\n        1414.0\n      ]\n    ],\n    "text": "!!",\n    "confidence": 0.5506755709648132\n  },\n  {\n    "bounding_box": [\n      [\n        2451.0,\n        1382.0\n      ],\n      [\n        2499.0,\n        1382.0\n      ],\n      [\n        2499.0,\n        1403.0\n      ],\n      [\n        2451.0,\n        1403.0\n      ]\n    ],\n    "text": "15:01",\n    "confidence": 0.9907203912734985\n  },\n  {\n    "bounding_box": [\n      [\n        2221.0,\n        1392.0\n      ],\n      [\n        2253.0,\n        1392.0\n      ],\n      [\n        2253.0,\n        1416.0\n      ],\n      [\n        2221.0,\n        1416.0\n      ]\n    ],\n    "text": "S",\n    "confidence": 0.8541669845581055\n  }\n]'},
                                    {'role': 'user',
                                     'content': "{'../image/template\\\\newqq_exit_but.png': [], '../image/template\\\\newqq_mainsetting_but.png': []}"},
                                    {'role': 'user',
                                     'content': "{'../image/template\\\\newqq_exit_but.png': [], '../image/template\\\\newqq_mainsetting_but.png': []}"},
                                    {'role': 'user',
                                     'content': "{'成功点击了QQ设置键"}
                                    ]

        nlp.deHistory_message(nlp.conversation_history)
        print(time)
